# üöÄ Docker Deployment & Testing Guide

This document provides a complete workflow for deploying and testing the **RAG system with the Discord bot, MongoDB, and AI service** using Docker Compose.

All commands assume you are in the project root directory (where `docker-compose.yml` is located).

---

## 1. Quick Start

```bash
# 1. Start all services (MongoDB, AI service, Bot)
docker compose up -d

# 2. View logs (ensure all services are running)
docker compose logs -f

# 3. Wait until AI service is ready (may take a few minutes to download models)
docker compose logs -f ai-service | grep "Application startup complete"

# 4. Ensure MongoDB indexes
docker compose exec bot node src/db/ensure-indexes.js

# 5. Ingest RAG resources
docker compose exec bot node scripts/ingest-rag.js

# 6. Run RAG smoke test
docker compose exec bot node scripts/rag-smoketest.js

# 7. Seed initial data (personas, scenarios, greetings, etc.)
docker compose exec bot node scripts/seed-all-local.js

# 8. Deploy Discord commands (including /game commands)
docker compose exec bot node scripts/deploy-commands.js
```

---

## 2. Data Seeding

```bash
# Seed everything
docker compose exec bot node scripts/seed-all-local.js

# Individual seeders
docker compose exec bot node scripts/seed-personas.js
docker compose exec bot node scripts/seed-scenarios.js
docker compose exec bot node scripts/seed-greetings.js
docker compose exec bot node scripts/seed-media.js
docker compose exec bot node scripts/seed-points.js
```

---

## 3. Functional Test Checklist

### üîé RAG System

```bash
# Count RAG chunks
docker compose exec mongo mongosh -u dev -p devpass --authenticationDatabase admin communiverse_bot \
  --eval "db.rag_chunks.countDocuments()"

# View a sample chunk
docker compose exec mongo mongosh -u dev -p devpass --authenticationDatabase admin communiverse_bot \
  --eval "db.rag_chunks.findOne()"

# Smoke test
docker compose exec bot node scripts/rag-smoketest.js
```

Expected: multiple chunks are loaded; test queries return scored results.

---

### ü§ñ Passive Persona Replies

In **Discord**:

* Send: `Who is Elio Solis?`
  Expected:
* Bot replies using Elio persona
* Reply contains RAG-retrieved info
* User gains +5 points
* Logs show: `[ROUTER] ‚Üí [RAG] ‚Üí [LLM]`

Check logs:

```bash
docker compose logs -f bot | grep -E "\[ROUTER\]|\[RAG\]|\[LLM\]"
```

Check DB:

```bash
# User affinity
docker compose exec mongo mongosh -u dev -p devpass --authenticationDatabase admin communiverse_bot \
  --eval "db.user_affinity.find().pretty()"

# Points
docker compose exec mongo mongosh -u dev -p devpass --authenticationDatabase admin communiverse_bot \
  --eval "db.profiles.find({}, {userId:1, points:1, level:1}).pretty()"
```

---

### üéÆ DM Mini-Game

In **Discord**:

1. Start game:

   ```
   /game dm-start
   /game dm-start persona:Elio
   ```

   ‚Üí Expected: First question shown (1/3).
2. Answer:

   ```
   /game dm-answer answer:Elio
   ```

   ‚Üí Correct: ‚úÖ feedback
   ‚Üí Incorrect: ‚ùå feedback
3. Check progress:

   ```
   /game dm-status
   ```

   ‚Üí Shows progress, score, correct answers.
4. Finish ‚Üí Final score, üåü PERFECT GAME if all correct.
5. Cancel game:

   ```
   /game dm-cancel
   ```

Logs:

```bash
docker compose logs -f bot | grep "\[DM-GAME\]"
```

---

### üìù Auto-Scenario Generation

```bash
# Wait for scheduled job (every 4h) OR trigger manually
docker compose exec bot node -e "
import('./src/jobs/autoScenarios.js').then(async m => {
  const mockClient = { guilds: { cache: new Map() } };
  await m.run(mockClient);
  console.log('Auto-scenario job completed');
})
"
```

Check generated data:

```bash
docker compose exec mongo mongosh -u dev -p devpass --authenticationDatabase admin communiverse_bot \
  --eval "db.scenarios.find({autoGenerated:true}).pretty()"
```

---

### üåå Cosmic Digest

```bash
# Insert digest schedule
docker compose exec mongo mongosh -u dev -p devpass --authenticationDatabase admin communiverse_bot --eval "
db.schedules.insertOne({
  guildId: 'YOUR_GUILD_ID',
  channelId: 'YOUR_CHANNEL_ID',
  kind: 'cosmic_digest',
  enabled: true,
  createdAt: new Date()
})
"

# Trigger job manually
docker compose exec bot node -e "
import('./src/jobs/cosmicDigest.js').then(async m => {
  const mockClient = {
    guilds: { cache: new Map([['guild1', { id: 'YOUR_GUILD_ID' }]]) },
    channels: { fetch: async (id) => ({ id, send: (c) => console.log('Digest posted:', c) }) }
  };
  await m.run(mockClient);
})
"
```

---

### üìä Channel Summary

```bash
# Insert summary schedule
docker compose exec mongo mongosh -u dev -p devpass --authenticationDatabase admin communiverse_bot --eval "
db.schedules.insertOne({
  guildId: 'YOUR_GUILD_ID',
  channelId: 'YOUR_CHANNEL_ID',
  kind: 'channel_summary',
  enabled: true,
  createdAt: new Date()
})
"

# Trigger manually
docker compose exec bot node -e "
import('./src/jobs/channelSummary.js').then(async m => {
  const mockClient = {
    guilds: { cache: new Map([['guild1', { id: 'YOUR_GUILD_ID' }]]) },
    channels: { fetch: async (id) => ({ id, send: (c) => console.log('Summary posted:', c) }) }
  };
  await m.run(mockClient);
})
"
```

---

### üñºÔ∏è Media Sweep

```bash
docker compose exec bot node -e "
import('./src/jobs/mediaSweep.js').then(async m => {
  const mockClient = { guilds: { cache: new Map() } };
  await m.run(mockClient);
  console.log('Media sweep completed');
})
"
```

---

## 4. Troubleshooting

### ‚ùå RAG Ingestion Fails

```bash
docker compose ps ai-service
docker compose logs ai-service | tail -100
docker compose exec bot curl http://ai-service:8000/embed/model-info
docker compose restart ai-service
```

### ‚ùå No Persona Replies

* Lower relevance threshold in `docker-compose.yml`:
  `RELEVANCE_THRESHOLD=0.4`
* Check relevance scores in logs
* Ensure personas exist in DB

### ‚ùå Jobs Not Running

```bash
docker compose logs bot | grep "Registered.*cron jobs"
docker compose logs bot | grep "\[SCHEDULER\]"
```

### ‚ùå DM Game Fails

* Check DM sessions index
* Ensure personas exist
* Clear stuck sessions

---

## 5. Performance Monitoring

```bash
# Container stats
docker stats

# Count docs in collections
docker compose exec mongo mongosh -u dev -p devpass --authenticationDatabase admin communiverse_bot --eval "
print('rag_chunks:', db.rag_chunks.countDocuments());
print('personas:', db.personas.countDocuments());
print('scenarios:', db.scenarios.countDocuments());
print('dm_sessions:', db.dm_sessions.countDocuments());
print('user_affinity:', db.user_affinity.countDocuments());
print('conversation_memory:', db.conversation_memory.countDocuments());
print('profiles:', db.profiles.countDocuments());
"
```

---

## 6. Rebuild & Reset

```bash
# Restart bot only
docker compose restart bot

# Rebuild bot after code changes
docker compose up -d --build bot

# Full rebuild
docker compose down
docker compose up -d --build

# Clean rebuild (‚ö† deletes DB data)
docker compose down -v
docker compose up -d --build
docker compose exec bot node src/db/ensure-indexes.js
docker compose exec bot node scripts/seed-all-local.js
docker compose exec bot node scripts/ingest-rag.js
```

---

## 7. Environment Variables

Inside `docker-compose.yml`:

```yaml
services:
  bot:
    environment:
      # Discord
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - APP_ID=${APP_ID}
      - GUILD_ID_DEV=${GUILD_ID_DEV}

      # MongoDB
      - MONGODB_URI=mongodb://dev:devpass@mongo:27017/?authSource=admin
      - DB_NAME=communiverse_bot

      # AI Service
      - AI_SERVICE_URL=http://ai-service:8000
      - AI_ENABLED=true

      # RAG
      - RAG_EMBEDDING_MODEL=bge-m3
      - RAG_EMBEDDING_DIM=1024
      - RAG_TOPK=8
      - RAG_MMR_LAMBDA=0.35
      - RAG_MIN_SCORE=0.25

      # Message Router
      - RELEVANCE_THRESHOLD=0.6

      # Cron Jobs
      - SCENARIO_CRON=0 */4 * * *
      - MEDIA_SWEEP_CRON=0 */6 * * *
      - COSMIC_DIGEST_CRON=0 10 * * *
      - DAILY_SUMMARY_CRON=0 23 * * *
```

