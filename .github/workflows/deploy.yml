# GitHub Actions CD - Deploy Workflow
# Deploys to live.dothost.net on push to main branch

name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: 'false'
        type: boolean
      deploy_commands:
        description: 'Deploy slash commands (dev/global/none)'
        required: false
        default: 'dev'
        type: choice
        options:
          - none
          - dev
          - global

env:
  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
  DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

jobs:
  # ===========================================
  # Run Tests First (unless skipped)
  # ===========================================
  test:
    name: Run Tests
    if: github.event.inputs.skip_tests != 'true'
    uses: ./.github/workflows/test.yml

  # ===========================================
  # Deploy to Production
  # ===========================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Save current deployment SHA
        run: |
          ssh -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "
            cd ${{ env.DEPLOY_PATH }} && \
            if [ -f .current_deploy ]; then
              cp .current_deploy .last_good_deploy
            fi
          " || true

      - name: Sync code to server
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude 'ai-service/__pycache__' \
            --exclude 'ai-service/.venv' \
            --exclude 'data/training/*.jsonl' \
            --exclude 'logs' \
            --exclude '.current_deploy' \
            --exclude '.last_good_deploy' \
            -e "ssh -p ${{ env.DEPLOY_PORT }}" \
            ./ ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Install dependencies and rebuild
        run: |
          ssh -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "
            cd ${{ env.DEPLOY_PATH }} && \
            npm ci --production && \
            docker compose build --no-cache
          "

      - name: Stop services
        run: |
          ssh -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "
            cd ${{ env.DEPLOY_PATH }} && \
            docker compose down || true
          "

      - name: Start services
        run: |
          ssh -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "
            cd ${{ env.DEPLOY_PATH }} && \
            docker compose up -d mongo && \
            sleep 5 && \
            docker compose up -d bot
          "

      - name: Run database migrations
        run: |
          ssh -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "
            cd ${{ env.DEPLOY_PATH }} && \
            docker compose exec -T bot npm run ensure-indexes || npm run ensure-indexes
          "

      - name: Seed database (if needed)
        run: |
          ssh -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "
            cd ${{ env.DEPLOY_PATH }} && \
            docker compose exec -T bot npm run seed:all || npm run seed:all
          " || true

      - name: Deploy slash commands
        if: github.event.inputs.deploy_commands != 'none'
        run: |
          DEPLOY_CMD="${{ github.event.inputs.deploy_commands || 'dev' }}"
          ssh -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "
            cd ${{ env.DEPLOY_PATH }} && \
            if [ \"$DEPLOY_CMD\" = \"global\" ]; then
              docker compose exec -T bot npm run deploy:global || npm run deploy:global
            else
              docker compose exec -T bot npm run deploy:dev || npm run deploy:dev
            fi
          "

      - name: Health check
        run: |
          sleep 10
          ssh -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "
            cd ${{ env.DEPLOY_PATH }} && \
            docker compose ps && \
            docker compose logs --tail=50 bot
          "

      - name: Save deployment SHA
        run: |
          ssh -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "
            cd ${{ env.DEPLOY_PATH }} && \
            echo '${{ github.sha }}' > .current_deploy && \
            echo 'Deployed: ${{ github.sha }} at $(date)' >> deployment.log
          "

      - name: Notify success
        if: success()
        run: |
          echo "Deployment successful!"
          echo "SHA: ${{ github.sha }}"
          echo "Deployed to: ${{ env.DEPLOY_HOST }}"

      - name: Notify failure
        if: failure()
        run: |
          echo "Deployment failed!"
          echo "Consider running rollback workflow"

  # ===========================================
  # Deploy AI Service (optional, requires GPU)
  # ===========================================
  deploy-ai-service:
    name: Deploy AI Service
    runs-on: ubuntu-latest
    needs: [deploy]
    if: false  # Disabled by default - enable when AI service is needed
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy AI Service
        run: |
          ssh -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "
            cd ${{ env.DEPLOY_PATH }} && \
            docker compose --profile ai build ai-service && \
            docker compose --profile ai up -d ai-service
          "
